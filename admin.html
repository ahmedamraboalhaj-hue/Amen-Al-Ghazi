<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التحكم الملكي | مستر أمين الغازي</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&family=Tajawal:wght@300;400;500;700;900&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.4);
            --secondary: #f59e0b;
            /* Gold/Amber */
            --accent: #10b981;
            --danger: #ef4444;
            --bg-dark: #030712;
            --bg-card: rgba(17, 24, 39, 0.7);
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --sidebar-width: 280px;
            --radius-xl: 30px;
            --radius-lg: 20px;
            --shadow-premium: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --font-main: 'Plus Jakarta Sans', 'Tajawal', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-main);
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
            background-image:
                radial-gradient(circle at 0% 0%, rgba(99, 102, 241, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 100% 100%, rgba(245, 158, 11, 0.1) 0%, transparent 40%);
        }

        /* Ambient Background Background */
        .ambient-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .blob {
            position: absolute;
            width: 500px;
            height: 500px;
            background: var(--primary-glow);
            filter: blur(100px);
            border-radius: 50%;
            animation: move 20s infinite alternate;
        }

        @keyframes move {
            from {
                transform: translate(-10%, -10%);
            }

            to {
                transform: translate(10%, 10%);
            }
        }

        /* Sidebar Styling */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: rgba(3, 7, 18, 0.8);
            backdrop-filter: blur(20px);
            border-left: 1px solid var(--glass-border);
            position: fixed;
            right: 0;
            top: 0;
            display: flex;
            flex-direction: column;
            padding: 40px 20px;
            z-index: 1000;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 50px;
            padding: 0 10px;
        }

        .logo-box {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 10px 20px var(--primary-glow);
        }

        .brand-text {
            font-weight: 800;
            font-size: 1.2rem;
            letter-spacing: -0.5px;
        }

        .nav-menu {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-grow: 1;
        }

        .nav-item {
            padding: 14px 20px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-muted);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .nav-item i {
            width: 24px;
            text-align: center;
            font-size: 1.1rem;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
            transform: translateX(-5px);
        }

        .nav-item.active {
            background: linear-gradient(to right, rgba(99, 102, 241, 0.1), transparent);
            color: var(--primary);
            border-right: 4px solid var(--primary);
        }

        .sidebar-footer {
            margin-top: auto;
            border-top: 1px solid var(--glass-border);
            padding-top: 20px;
        }

        .logout-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 14px 20px;
            color: var(--danger);
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
            transition: 0.3s;
        }

        .logout-btn:hover {
            transform: translateX(-5px);
            opacity: 0.8;
        }

        /* Main Content */
        .main {
            margin-right: var(--sidebar-width);
            flex-grow: 1;
            padding: 50px;
            max-width: 1400px;
            margin-left: auto;
            transition: margin 0.4s;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 40px;
        }

        .greeting h1 {
            font-size: 2.2rem;
            font-weight: 800;
            letter-spacing: -1px;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #fff 0%, #cbd5e1 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .greeting p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* Stat Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            padding: 30px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-premium);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 40px -10px var(--primary-glow);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--primary);
        }

        .stat-info h3 {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: 4px;
        }

        .stat-info .stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: #fff;
        }

        /* Glass Panel Styling */
        .panel {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-premium);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .panel-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .panel-title i {
            color: var(--primary);
        }

        /* Form Controls */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: #fff;
            font-family: inherit;
            font-size: 1rem;
            transition: 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.06);
            box-shadow: 0 0 20px var(--primary-glow);
        }

        .btn {
            padding: 14px 30px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            border: none;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #4f46e5);
            color: white;
            box-shadow: 0 10px 20px var(--primary-glow);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: white;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Table Styling */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            border-radius: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: right;
        }

        th {
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        td {
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            font-size: 0.95rem;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--secondary);
        }

        /* Animation */
        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile Adjustments */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main {
                margin-right: 0;
                padding: 30px 20px;
            }

            .mobile-trigger {
                display: flex !important;
            }
        }

        .mobile-trigger {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--primary);
            border-radius: 12px;
            z-index: 2000;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 10px 20px var(--primary-glow);
        }

        /* Loading Spinner */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Admin Login Overlay */
        #admin-login-overlay {
            position: fixed;
            inset: 0;
            background: #0f172a;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 24px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .login-card .logo-box {
            margin: 0 auto 25px;
            width: 70px;
            height: 70px;
            font-size: 2rem;
        }

        .login-card h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #fff;
        }

        .login-card p {
            color: var(--text-muted);
            margin-bottom: 30px;
        }
    </style>
</head>

<body>
    <div class="ambient-bg">
        <div class="blob"></div>
    </div>

    <!-- Admin Login Overlay -->
    <div id="admin-login-overlay">
        <div class="login-card">
            <div class="logo-box"><i class="fas fa-lock"></i></div>
            <h2>دخول المشرف</h2>
            <p>برجاء إدخال كلمة المرور للمتابعة</p>
            <div class="form-group">
                <input type="password" id="admin-pass-input" class="form-control" placeholder="كلمة المرور..."
                    style="text-align: center; letter-spacing: 5px; font-size: 1.2rem;">
            </div>
            <button class="btn btn-primary w-100" onclick="checkAdminLogin()">دخول المنصة <i
                    class="fas fa-sign-in-alt"></i></button>
        </div>
    </div>

    <!-- Mobile Trigger -->
    <div class="mobile-trigger" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            <div class="logo-box"><i class="fas fa-crown"></i></div>
            <div class="teacher">مستر أمين الغازي</div>
        </div>

        <ul class="nav-menu">
            <li class="nav-item active" data-id="overview"><i class="fas fa-chart-pie"></i> نظرة عامة</li>
            <li class="nav-item" data-id="students"><i class="fas fa-user-graduate"></i> إدارة الطلاب</li>
            <li class="nav-item" data-id="lectures"><i class="fas fa-clapperboard"></i> المحاضرات</li>
            <li class="nav-item" data-id="quizzes"><i class="fas fa-scroll"></i> الاختبارات</li>
            <li class="nav-item" data-id="results"><i class="fas fa-poll"></i> نتائج الاختبارات</li>
            <li class="nav-item" data-id="views"><i class="fas fa-eye"></i> مشاهدات الدروس</li>
            <li class="nav-item" data-id="vouchers"><i class="fas fa-ticket"></i> أكواد التفعيل</li>
            <li class="nav-item" data-id="broadcast"><i class="fas fa-broadcast-tower"></i> البث المباشر</li>
            <li class="nav-item" data-id="competition" style="color: var(--accent);"><i class="fas fa-trophy"></i> إدارة
                المسابقات</li>
            <li class="nav-item" data-id="settings"><i class="fas fa-sliders"></i> الإعدادات</li>
            <li class="nav-item" data-id="master" style="color: var(--secondary);"><i class="fas fa-atom"></i> النظام
                الرئيسي</li>
        </ul>

        <div class="sidebar-footer">
            <button onclick="adminLogout()" class="logout-btn"
                style="width: 100%; background: none; border: none; cursor: pointer; text-align: right; display: flex; align-items: center; gap: 10px; padding: 10px; color: var(--text-muted);">
                <i class="fas fa-sign-out-alt"></i>
                <span>تسجيل الخروج</span>
            </button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="main">
        <header class="header-top">
            <div class="greeting">
                <h1 id="teacher-title">مرحباً، مستر أمين الغازي</h1>
                <p>إدارة المنصة بكل احترافية وسهولة.</p>
            </div>
            <div class="header-actions">
                <div class="badge badge-success" style="padding: 10px 20px;">
                    <i class="fas fa-circle"
                        style="font-size: 0.6rem; margin-left: 8px; animation: pulse 2s infinite;"></i>
                    النظام متصل
                </div>
            </div>
        </header>

        <!-- Dynamic Sections -->

        <!-- Overview Section -->
        <section id="section-overview" class="section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    <div class="stat-info">
                        <h3>إجمالي الطلاب</h3>
                        <div class="stat-value" id="stat-students">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="color: var(--secondary); background: rgba(245,158,11,0.1);"><i
                            class="fas fa-ticket"></i></div>
                    <div class="stat-info">
                        <h3>أكواد مفعلة</h3>
                        <div class="stat-value" id="stat-vouchers">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="color: var(--accent); background: rgba(16,185,129,0.1);"><i
                            class="fas fa-video"></i></div>
                    <div class="stat-info">
                        <h3>المحاضرات</h3>
                        <div class="teacher">مستر أمين الغازي - لغة عربية</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="color: var(--danger); background: rgba(239,68,68,0.1);"><i
                            class="fas fa-eye"></i></div>
                    <div class="stat-info">
                        <h3>زيارات اليوم</h3>
                        <div class="stat-value" id="stat-visits">0</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title"><i class="fas fa-bolt"></i> النشاط الأخير</h2>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>الوقت</th>
                                <th>الطالب</th>
                                <th>النشاط</th>
                                <th>تفاصيل</th>
                            </tr>
                        </thead>
                        <tbody id="recent-activity">
                            <!-- Activities here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Students Section -->
        <section id="section-students" class="section">
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title"><i class="fas fa-search"></i> البحث عن طالب</h2>
                </div>
                <div class="form-grid">
                    <input type="text" class="form-control" id="search-student"
                        placeholder="ابحث بالاسم أو رقم الهاتف..." oninput="filterTable('students-table', this.value)">
                    <select class="form-control" id="filter-grade" onchange="filterTable('students-table', this.value)">
                        <option value="">كل الصفوف</option>
                        <option value="1prep">أولى إعدادي</option>
                        <option value="2prep">تانية إعدادي</option>
                        <option value="3prep">تالتة إعدادي</option>
                        <option value="1sec">أولى ثانوي</option>
                        <option value="2sec">تانية ثانوي</option>
                        <option value="3sec">تالتة ثانوي</option>
                    </select>
                </div>
                <div class="table-wrapper">
                    <table id="students-table">
                        <thead>
                            <tr>
                                <th>الاسم</th>
                                <th>الصف</th>
                                <th>الهاتف</th>
                                <th>ولي الأمر</th>
                                <th>المجموعة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="students-list">
                            <!-- Students here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Lectures Section -->
        <section id="section-lectures" class="section">
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title"><i class="fas fa-plus"></i> إضافة محاضرة جديدة</h2>
                </div>
                <div class="form-grid" style="grid-template-columns: 2fr 1fr;">
                    <div class="form-group">
                        <label>عنوان المحاضرة</label>
                        <input type="text" class="form-control" id="lec-title" placeholder="مثال: شرح المبتدأ والخبر">
                    </div>
                    <div class="form-group">
                        <label>الصف الدراسي</label>
                        <select class="form-control" id="lec-grade">
                            <option value="1prep">أولى إعدادي</option>
                            <option value="2prep">تانية إعدادي</option>
                            <option value="3prep">تالتة إعدادي</option>
                            <option value="1sec">أولى ثانوي</option>
                            <option value="2sec">تانية ثانوي</option>
                            <option value="3sec">تالتة ثانوي</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>رابط اليوتيوب (URL)</label>
                        <input type="text" class="form-control" id="lec-url"
                            placeholder="https://youtube.com/watch?v=...">
                    </div>
                    <div class="form-group">
                        <label>الفرع (المادة)</label>
                        <select class="form-control" id="lec-branch">
                            <option value="عام">عام</option>
                            <option value="نحو">نحو</option>
                            <option value="بلاغة">بلاغة</option>
                            <option value="أدب">أدب</option>
                            <option value="قراءة">قراءة</option>
                            <option value="قصة">قصة</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>شهر المحاضرة</label>
                        <select class="form-control" id="lec-month">
                            <option value="all">دائم (بدون شهر)</option>
                            <option value="9">شهر سبتمبر (9)</option>
                            <option value="10">شهر أكتوبر (10)</option>
                            <option value="11">شهر نوفمبر (11)</option>
                            <option value="12">شهر ديسمبر (12)</option>
                            <option value="1">شهر يناير (1)</option>
                            <option value="2">شهر فبراير (2)</option>
                            <option value="3">شهر مارس (3)</option>
                            <option value="4">شهر أبريل (4)</option>
                            <option value="5">شهر مايو (5)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>المجموعة (السنتر)</label>
                        <select class="form-control" id="lec-group">
                            <option value="all">الكل (عام)</option>
                            <option value="online">أونلاين فقط</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="publishLecture()"><i class="fas fa-upload"></i> نشر المحاضرة
                    الآن</button>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title"><i class="fas fa-list"></i> المحاضرات الحالية</h2>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>المحاضرة</th>
                                <th>الصف</th>
                                <th>التاريخ</th>
                                <th>التحكم</th>
                            </tr>
                        </thead>
                        <tbody id="existing-lectures">
                            <!-- Lectures here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Vouchers Section -->
        <section id="section-vouchers" class="section">
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title"><i class="fas fa-magic"></i> توليد أكواد تفعيل</h2>
                </div>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label>الصف الدراسي</label>
                        <select class="form-control" id="vouch-grade">
                            <option value="1prep">أولى إعدادي</option>
                            <option value="2prep">تانية إعدادي</option>
                            <option value="3prep">تالتة إعدادي</option>
                            <option value="1sec">أولى ثانوي</option>
                            <option value="2sec">تانية ثانوي</option>
                            <option value="3sec">تالتة ثانوي</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>تخصيص لشهر</label>
                        <select class="form-control" id="vouch-month">
                            <option value="all">يعمل على الكل</option>
                            <option value="9">سبتمر (9)</option>
                            <option value="10">أكتوبر (10)</option>
                            <option value="11">نوفمبر (11)</option>
                            <option value="12">ديسمبر (12)</option>
                            <option value="1">يناير (1)</option>
                            <option value="2">فبراير (2)</option>
                            <option value="3">مارس (3)</option>
                            <option value="4">أبريل (4)</option>
                            <option value="5">مايو (5)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>الكمية للتوليد</label>
                        <input type="number" class="form-control" id="vouch-count" value="50">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary w-100" onclick="generateVouchers()">توليد الآن</button>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title"><i class="fas fa-print"></i> طباعة أكواد (كمية محددة)</h2>
                </div>
                <div class="form-grid" style="grid-template-columns: 2fr 1fr 1fr;">
                    <div class="form-group">
                        <label>الصف المراد طباعته</label>
                        <select class="form-control" id="print-grade-select">
                            <option value="1prep">أولى إعدادي</option>
                            <option value="2prep">تانية إعدادي</option>
                            <option value="3prep">تالتة إعدادي</option>
                            <option value="1sec">أولى ثانوي</option>
                            <option value="2sec">تانية ثانوي</option>
                            <option value="3sec">تالتة ثانوي</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>عدد الأكواد (متاح فقط)</label>
                        <input type="number" class="form-control" id="print-count-input" value="10">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-secondary w-100" onclick="printCustomVouchers()"><i
                                class="fas fa-print"></i> طباعة המختار</button>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title"><i class="fas fa-key"></i> قائمة الأكواد</h2>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>الكود</th>
                                <th>الصف</th>
                                <th>طالب الكود (اختياري)</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="vouchers-list">
                            <!-- Vouchers here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Broadcast Section -->
        <section id="section-broadcast" class="section">
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title"><i class="fas fa-paper-plane"></i> إرسال رسالة تنبيهية</h2>
                </div>
                <div class="form-group">
                    <label>نص الرسالة (تظهر لجميع الطلاب المسجلين)</label>
                    <textarea class="form-control" id="broadcast-msg" rows="5"
                        placeholder="اكتب رسالتك التحفيزية أو الإدارية هنا..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="sendBroadcast()"><i class="fas fa-bullhorn"></i> إرسال التنبيه
                    الآن</button>
            </div>
        </section>

        <!-- Quizzes Section -->
        <section id="section-quizzes" class="section">
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title"><i class="fas fa-file-signature"></i> إنشاء اختبار جديد</h2>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>عنوان الاختبار</label>
                        <input type="text" class="form-control" id="quiz-title" placeholder="اختبار شهر أكتوبر">
                    </div>
                    <div class="form-group">
                        <label>الصف الدراسي</label>
                        <select class="form-control" id="quiz-grade">
                            <option value="1prep">أولى إعدادي</option>
                            <option value="2prep">تانية إعدادي</option>
                            <option value="3prep">تالتة إعدادي</option>
                            <option value="1sec">أولى ثانوي</option>
                            <option value="2sec">تانية ثانوي</option>
                            <option value="3sec">تالتة ثانوي</option>
                        </select>
                    </div>
                </div>

                <div id="questions-container">
                    <!-- Questions will be added here -->
                </div>

                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="addQuestionRaw()"><i class="fas fa-plus"></i> إضافة
                        سؤال</button>
                    <button class="btn btn-primary" onclick="saveQuiz()"><i class="fas fa-save"></i> حفظ ونشر
                        الاختبار</button>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title"><i class="fas fa-clipboard-list"></i> الاختبارات الحالية</h2>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>الاختبار</th>
                                <th>الصف</th>
                                <th>الأسئلة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="existing-quizzes">
                            <!-- Quizzes List -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Quiz Results Section -->
        <section id="section-results" class="section">
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title"><i class="fas fa-poll"></i> قاعدة بيانات نتائج الطلاب</h2>
                </div>
                <div class="form-grid">
                    <input type="text" class="form-control" placeholder="ابحث باسم الطالب..."
                        oninput="filterTable('results-table', this.value)">
                </div>
                <div class="table-wrapper">
                    <table id="results-table">
                        <thead>
                            <tr>
                                <th>الوقت</th>
                                <th>الطالب</th>
                                <th>الاختبار</th>
                                <th>الدرجة</th>
                                <th>النسبة</th>
                                <th>التقرير</th>
                                <th>حذف</th>
                            </tr>
                        </thead>
                        <tbody id="results-list">
                            <!-- Results here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Video Views Section -->
        <section id="section-views" class="section">
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title"><i class="fas fa-eye"></i> قاعدة بيانات مشاهدات الدروس</h2>
                </div>
                <div class="form-grid">
                    <input type="text" class="form-control" placeholder="ابحث باسم الطالب أو الدرس..."
                        oninput="filterTable('views-table', this.value)">
                </div>
                <div class="table-wrapper">
                    <table id="views-table">
                        <thead>
                            <tr>
                                <th>الوقت</th>
                                <th>الطالب</th>
                                <th>اسم الدرس</th>
                                <th>الصف</th>
                                <th>حذف</th>
                            </tr>
                        </thead>
                        <tbody id="views-list">
                            <!-- Views here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Competition Section -->
        <section id="section-competition" class="section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="color: var(--accent); background: rgba(16,185,129,0.1);"><i
                            class="fas fa-check-circle"></i></div>
                    <div class="stat-info">
                        <h3>حالة المسابقة</h3>
                        <div class="stat-value" id="comp-status-text">غير مفعلة</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="color: var(--secondary); background: rgba(245,158,11,0.1);"><i
                            class="fas fa-users"></i></div>
                    <div class="stat-info">
                        <h3>المشاركين</h3>
                        <div class="stat-value" id="comp-participants-count">0</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title"><i class="fas fa-tools"></i> إعدادات المسابقة</h2>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>تفعيل المسابقة</label>
                        <select class="form-control" id="comp-active-toggle" onchange="updateCompConfig()">
                            <option value="false">إيقاف</option>
                            <option value="true">تفعيل</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>عنوان المسابقة</label>
                        <input type="text" class="form-control" id="comp-title-input"
                            placeholder="مثال: مسابقة العباقرة" onchange="updateCompConfig()">
                    </div>
                    <div class="form-group">
                        <label>الجائزة</label>
                        <input type="text" class="form-control" id="comp-prize-input" placeholder="مثال: 500 جنيه"
                            onchange="updateCompConfig()">
                    </div>
                </div>
                <div class="form-group">
                    <label>وصف المسابقة والشروط</label>
                    <textarea class="form-control" id="comp-desc-input" rows="3"
                        onchange="updateCompConfig()"></textarea>
                </div>
                <button class="btn btn-danger" onclick="resetCompetition()"><i class="fas fa-trash"></i> تصفير بيانات
                    المسابقة</button>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title"><i class="fas fa-medal"></i> المتصدرون (المسطرة)</h2>
                </div>
                <div class="table-wrapper">
                    <table id="comp-leaderboard">
                        <thead>
                            <tr>
                                <th>المركز</th>
                                <th>الطالب</th>
                                <th>النقاط</th>
                                <th>مرات الفوز</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="comp-leaderboard-list">
                            <!-- Leaderboard here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        <section id="section-settings" class="section">
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title"><i class="fas fa-cog"></i> إعدادات المنصة</h2>
                </div>
                <div class="form-group">
                    <label>اسم الملحق التعليمي (يظهر في العنوان)</label>
                    <input type="text" class="form-control" id="set-teacher-name" value="مستر أمين الغازي">
                </div>
                <div class="form-group">
                    <label>عنوان المنصة الرئيسي</label>
                    <input type="text" class="form-control" id="set-platform-title" value="لوحة التحكم الملكية">
                </div>
                <button class="btn btn-primary" onclick="saveSettings()"><i class="fas fa-check"></i> حفظ
                    التغييرات</button>
            </div>
        </section>

        <script>
            async function saveSettings() {
                const name = document.getElementById('set-teacher-name').value;
                const title = document.getElementById('set-platform-title').value;
                try {
                    await db.collection('platform_data').doc('config').set({
                        teacherName: name,
                        platformTitle: title
                    });
                    alert('تم حفظ الإعدادات!');
                    location.reload();
                } catch (e) { alert('خطأ في الحفظ'); }
            }

            // Load Settings
            async function loadSettings() {
                const doc = await db.collection('platform_data').doc('config').get();
                if (doc.exists) {
                    const d = doc.data();
                    document.getElementById('teacher-title').innerText = 'مرحباً، ' + d.teacherName;
                    document.getElementById('set-teacher-name').value = d.teacherName;
                    document.querySelectorAll('.brand-text').forEach(el => el.innerText = d.platformTitle);
                    document.getElementById('set-platform-title').value = d.platformTitle;
                }
            }
            window.addEventListener('load', loadSettings);
        </script>

        <!-- Master Section -->
        <section id="section-master" class="section">
            <div class="panel" style="border-color: var(--danger);">
                <div class="panel-header">
                    <h2 class="panel-title" style="color: var(--danger);"><i class="fas fa-triangle-exclamation"></i>
                        تصفير النظام بالكامل</h2>
                </div>
                <p style="color: var(--text-muted); margin-bottom: 20px;">هذا الخيار سوف يقوم بحذف جميع بيانات الطلاب،
                    زياراتهم، ونتائج اختباراتهم. (سيتم الإبقاء على المحاضرات والأسئلة).</p>
                <div class="form-group">
                    <label>اكتب "تصفير نهائي" للتأكيد</label>
                    <input type="text" class="form-control" id="master-confirm" placeholder="...">
                </div>
                <button class="btn btn-danger" onclick="systemReset()"><i class="fas fa-skull"></i> تصفير النظام
                    الآن</button>
            </div>
        </section>

    </main>

    <div class="loader" id="page-loader">
        <div class="logo-box" style="width: 80px; height: 80px; font-size: 2.5rem; animation: pulse 2s infinite;">
            <i class="fas fa-crown"></i>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- Firebase Config (Linked to your project) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCoUAGpTJANr-voTNxvEIlos2I8w_1kXtA",
            authDomain: "yghjni.firebaseapp.com",
            projectId: "yghjni",
            storageBucket: "yghjni.firebasestorage.app",
            messagingSenderId: "629167303662",
            appId: "1:629167303662:web:91069e95be3ac626c13cff",
            measurementId: "G-NT4EF36RFT"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- Navigation ---
        document.querySelectorAll('.nav-item').forEach(item => {
            item.onclick = () => {
                const targetId = item.getAttribute('data-id');

                // UI Sync
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                // Section Sync
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                const targetSection = document.getElementById('section-' + targetId);
                if (targetSection) targetSection.classList.add('active');

                // Mobile Close
                if (window.innerWidth <= 1024) toggleSidebar();
            };
        });

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // --- Admin Auth ---
        function checkAdminLogin() {
            const pass = document.getElementById('admin-pass-input').value;
            if (pass === '010qwe') {
                localStorage.setItem('admin_auth', 'true');
                document.getElementById('admin-login-overlay').style.display = 'none';
            } else {
                alert('كلمة المرور غير صحيحة!');
            }
        }

        function adminLogout() {
            localStorage.removeItem('admin_auth');
            location.href = 'index.html';
        }

        if (localStorage.getItem('admin_auth') === 'true') {
            document.getElementById('admin-login-overlay').style.display = 'none';
        }

        // --- Data Fetching ---
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('page-loader').style.opacity = '0';
                setTimeout(() => document.getElementById('page-loader').remove(), 500);
            }, 1000);

            initRealtimeStats();
            loadLectures();
            loadStudents();
            loadVouchers();
            loadRecentActivity();
            loadQuizResults();
            loadLessonViews();
            loadCompetitionData();
        });

        async function loadCompetitionData() {
            // Load Config
            const configDoc = await db.collection('platform_data').doc('competition_config').get();
            if (configDoc.exists) {
                const data = configDoc.data();
                document.getElementById('comp-active-toggle').value = data.active.toString();
                document.getElementById('comp-title-input').value = data.title || '';
                document.getElementById('comp-prize-input').value = data.prize || '';
                document.getElementById('comp-desc-input').value = data.description || '';
                document.getElementById('comp-status-text').innerText = data.active ? 'مفعلة الآن' : 'غير مفعلة';
                document.getElementById('comp-status-text').style.color = data.active ? 'var(--accent)' : 'var(--danger)';
            }

            // Load Participants / Leaderboard
            db.collection('competition_participants').orderBy('points', 'desc').onSnapshot(snap => {
                const container = document.getElementById('comp-leaderboard-list');
                if (!container) return;
                container.innerHTML = '';
                document.getElementById('comp-participants-count').innerText = snap.size;

                let rank = 1;
                snap.forEach(doc => {
                    const p = doc.data();
                    container.innerHTML += `
                        <tr>
                            <td><span class="badge ${rank <= 3 ? 'badge-success' : 'badge-warning'}">${rank}#</span></td>
                            <td style="font-weight:700;">${p.name}</td>
                            <td>${p.points || 0}</td>
                            <td>${p.wins || 0}</td>
                            <td>
                                <button onclick="deleteDoc('competition_participants', '${doc.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer;"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>
                    `;
                    rank++;
                });
            });
        }

        async function updateCompConfig() {
            const active = document.getElementById('comp-active-toggle').value === 'true';
            const title = document.getElementById('comp-title-input').value;
            const prize = document.getElementById('comp-prize-input').value;
            const description = document.getElementById('comp-desc-input').value;

            try {
                await db.collection('platform_data').doc('competition_config').set({
                    active, title, prize, description,
                    updatedAt: Date.now()
                });
                document.getElementById('comp-status-text').innerText = active ? 'مفعلة الآن' : 'غير مفعلة';
                document.getElementById('comp-status-text').style.color = active ? 'var(--accent)' : 'var(--danger)';
            } catch (e) {
                console.error(e);
            }
        }

        async function resetCompetition() {
            if (!confirm('سيتم حذف جميع المشتركين ونقاطهم، هل أنت متأكد؟')) return;
            const snap = await db.collection('competition_participants').get();
            const batch = db.batch();
            snap.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            alert('تم تصفير المسابقة!');
        }

        function loadQuizResults() {
            db.collection('quiz_results').orderBy('timestamp', 'desc').onSnapshot(snap => {
                const container = document.getElementById('results-list');
                if (!container) return;
                container.innerHTML = '';
                snap.forEach(doc => {
                    const r = doc.data();
                    const time = r.timestamp ? new Date(r.timestamp).toLocaleString('ar-EG') : '---';
                    container.innerHTML += `
                        <tr>
                            <td style="font-size:0.8rem;">${time}</td>
                            <td style="font-weight:700;">${r.studentName}</td>
                            <td>${r.quizTitle}</td>
                            <td>${r.score} / ${r.total}</td>
                            <td><span class="badge ${r.percent >= 50 ? 'badge-success' : 'badge-danger'}">${r.percent}%</span></td>
                            <td><a href="report.html?id=${doc.id}" target="_blank" style="color:var(--primary);"><i class="fas fa-file-pdf"></i> عرض</a></td>
                            <td>
                                <button onclick="deleteDoc('quiz_results', '${doc.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer;"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>
                    `;
                });
            });
        }

        function loadLessonViews() {
            db.collection('views').orderBy('timestamp', 'desc').onSnapshot(snap => {
                const container = document.getElementById('views-list');
                if (!container) return;
                container.innerHTML = '';
                snap.forEach(doc => {
                    const v = doc.data();
                    const time = v.timestamp ? new Date(v.timestamp).toLocaleString('ar-EG') : '---';
                    container.innerHTML += `
                        <tr>
                            <td style="font-size:0.8rem;">${time}</td>
                            <td style="font-weight:700;">${v.studentName}</td>
                            <td>${v.lessonTitle}</td>
                            <td><span class="badge badge-warning">${getGradeName(v.grade)}</span></td>
                            <td>
                                <button onclick="deleteDoc('views', '${doc.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer;"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>
                    `;
                });
            });
        }

        function initRealtimeStats() {
            db.collection('students').onSnapshot(snap => {
                document.getElementById('stat-students').innerText = snap.size;
            });
            db.collection('vouchers').where('used', '==', true).onSnapshot(snap => {
                document.getElementById('stat-vouchers').innerText = snap.size;
            });
            db.collection('lessons').onSnapshot(snap => {
                document.getElementById('stat-lessons').innerText = snap.size;
            });
            db.collection('student_visits').onSnapshot(snap => {
                // Approximate today's visits
                const today = new Date().toLocaleDateString('ar-EG');
                let count = 0;
                snap.forEach(doc => {
                    const d = doc.data();
                    if (d.dateString === today || (d.timestamp && d.timestamp.toDate().toLocaleDateString('ar-EG') === today)) count++;
                });
                document.getElementById('stat-visits').innerText = count;
            });
        }

        async function loadLectures() {
            db.collection('lessons').orderBy('createdAt', 'desc').onSnapshot(snap => {
                const container = document.getElementById('existing-lectures');
                if (!container) return;
                container.innerHTML = '';
                snap.forEach(doc => {
                    const l = doc.data();
                    container.innerHTML += `
                        <tr>
                            <td style="font-weight:700;">
                                ${l.title}
                                <div style="font-size: 0.7rem; color: #64748b;">الفرع: ${l.branch || 'عام'} | الشهر: ${l.month || 'عام'}</div>
                            </td>
                            <td><span class="badge badge-warning">${getGradeName(l.grade)}</span></td>
                            <td>${l.date || '-'}</td>
                            <td>
                                <button onclick="deleteDoc('lessons', '${doc.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer;"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>
                    `;
                });
            });
        }

        function loadStudents() {
            db.collection('students').orderBy('name').onSnapshot(snap => {
                const container = document.getElementById('students-list');
                container.innerHTML = '';
                snap.forEach(doc => {
                    const s = doc.data();
                    container.innerHTML += `
                        <tr>
                            <td style="font-weight:700;">${s.name}</td>
                            <td>${getGradeName(s.grade || s.year)}</td>
                            <td>${s.phone}</td>
                            <td>${s.parentPhone || '-'}</td>
                            <td>${s.group || 'أونلاين'}</td>
                            <td>
                                <button onclick="deleteDoc('students', '${doc.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer;"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>
                    `;
                });
            });
        }

        function loadVouchers() {
            db.collection('vouchers').orderBy('timestamp', 'desc').limit(150).onSnapshot(snap => {
                const container = document.getElementById('vouchers-list');
                if (!container) return;
                container.innerHTML = '';
                snap.forEach(doc => {
                    const v = doc.data();
                    container.innerHTML += `
                        <tr>
                            <td style="font-family:monospace; font-weight:700; color:var(--secondary);">${v.code}</td>
                            <td>${getGradeName(v.grade)}</td>
                            <td>
                                <input type="text" class="form-control" style="padding: 5px 10px; font-size: 0.85rem;" 
                                    placeholder="اسم الطالب..." value="${v.studentName || ''}" 
                                    onchange="updateVoucherName('${doc.id}', this.value)">
                            </td>
                            <td><span class="badge ${v.used ? 'badge-danger' : 'badge-success'}">${v.used ? 'مستخدم' : 'متاح'}</span></td>
                            <td>
                                <button onclick="deleteDoc('vouchers', '${doc.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer;"><i class="fas fa-trash-alt"></i></button>
                                <button onclick="printCode('${v.code}', '${v.grade}', '${v.studentName || ''}')" style="background:none; border:none; color:var(--primary); cursor:pointer; margin-right:10px;"><i class="fas fa-print"></i></button>
                            </td>
                        </tr>
                    `;
                });
            });
        }

        async function updateVoucherName(id, name) {
            try {
                await db.collection('vouchers').doc(id).update({ studentName: name });
            } catch (e) { console.error("Error updating name:", e); }
        }

        function loadRecentActivity() {
            db.collection('student_visits').orderBy('timestamp', 'desc').limit(10).onSnapshot(snap => {
                const container = document.getElementById('recent-activity');
                container.innerHTML = '';
                snap.forEach(doc => {
                    const a = doc.data();
                    const time = a.timestamp ? a.timestamp.toDate().toLocaleTimeString('ar-EG') : '---';
                    container.innerHTML += `
                        <tr>
                            <td style="font-size:0.8rem; color:var(--text-muted);">${time}</td>
                            <td style="font-weight:600;">${a.studentName || 'زائر'}</td>
                            <td><i class="fas fa-sign-in-alt" style="margin-left:8px; color:var(--accent);"></i> دخول للمنصة</td>
                            <td>${getGradeName(a.grade || a.year)}</td>
                        </tr>
                    `;
                });
            });
        }

        // --- Logic Functions ---

        async function publishLecture() {
            const title = document.getElementById('lec-title').value;
            const url = document.getElementById('lec-url').value;
            const grade = document.getElementById('lec-grade').value;
            const branch = document.getElementById('lec-branch').value;
            const month = document.getElementById('lec-month').value;
            const group = document.getElementById('lec-group').value;

            if (!title || !url) return alert('برجاء ملء البيانات الأساسية');

            const id = extractYTId(url);
            if (!id) return alert('رابط يوتيوب غير صحيح');

            try {
                await db.collection('lessons').add({
                    title, youtubeId: id, grade, branch, month, group,
                    createdAt: Date.now(),
                    date: new Date().toLocaleDateString('ar-EG')
                });
                alert('تم النشر بنجاح!');
                document.getElementById('lec-title').value = '';
                document.getElementById('lec-url').value = '';
            } catch (err) { alert('خطأ في الاتصال'); }
        }

        async function generateVouchers() {
            const grade = document.getElementById('vouch-grade').value;
            const month = document.getElementById('vouch-month').value;
            const countInput = document.getElementById('vouch-count');
            const count = parseInt(countInput.value);
            if (!count || count < 1) return alert('برجاء إدخال كمية صحيحة');

            if (!confirm(`هل تريد توليد ${count} كود لـ ${getGradeName(grade)} لشهر ${month === 'all' ? 'الكل' : month}؟`)) return;

            const batch = db.batch();
            for (let i = 0; i < count; i++) {
                const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                const ref = db.collection('vouchers').doc();
                batch.set(ref, {
                    code, grade, month, used: false, studentName: '',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            try {
                await batch.commit();
                alert(`تم توليد ${count} كود بنجاح!`);
                countInput.value = '50';
            } catch (err) { alert('خطأ في توليد الأكواد'); }
        }

        async function sendBroadcast() {
            const msg = document.getElementById('broadcast-msg').value;
            if (!msg) return;
            try {
                await db.collection('platform_data').doc('announcement').set({
                    text: msg,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('تم الإرسال لجميع الطلاب!');
                document.getElementById('broadcast-msg').value = '';
            } catch (e) { alert('خطأ في الإرسال'); }
        }

        async function systemReset() {
            const confirm = document.getElementById('master-confirm').value;
            if (confirm !== 'تصفير نهائي') return alert('برجاء التأكيد بكتابة العبارة الصحيحة');

            const collections = ['students', 'student_visits', 'quiz_results', 'views'];
            for (const col of collections) {
                const snap = await db.collection(col).get();
                const batch = db.batch();
                snap.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            }
            alert('تم تصفير النظام بنجاح!');
            window.location.reload();
        }

        // --- Helpers ---
        function extractYTId(url) {
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[7].length == 11) ? match[7] : url;
        }

        function getGradeName(code) {
            const map = {
                '1prep': 'أولى إعدادي', '2prep': 'تانية إعدادي', '3prep': 'تالتة إعدادي',
                '1sec': 'أولى ثانوي', '2sec': 'تانية ثانوي', '3sec': 'تالتة ثانوي'
            };
            return map[code] || code;
        }

        async function deleteDoc(col, id) {
            if (confirm('هل أنت متأكد من الحذف؟')) {
                await db.collection(col).doc(id).delete();
            }
        }

        function filterTable(tableId, query) {
            const q = query.toLowerCase();
            const rows = document.querySelectorAll(`#${tableId} tbody tr`);
            rows.forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(q) ? '' : 'none';
            });
        }

        function printCode(code, grade, sName = '') {
            const win = window.open('', '_blank');
            win.document.write(`
                <div style="border:3px dashed #6366f1; padding:30px; text-align:center; direction:rtl; font-family:sans-serif; max-width:400px; margin:auto; border-radius:20px;">
                    <h1 style="color:#6366f1; margin:0 0 10px 0;">مستر أمين الغازي</h1>
                    <p style="font-size:1.1rem; color:#475569; margin:5px 0;">${getGradeName(grade)}</p>
                    <div style="font-size:2.8rem; font-weight:bold; margin:30px 0; background:#f1f5f9; padding:15px; border-radius:12px; letter-spacing:8px;">${code}</div>
                    ${sName ? `<h2 style="color:#1e293b; margin:10px 0;">الطالب: ${sName}</h2>` : '<div style="height:40px; border-bottom:1px solid #ccc; margin:20px 0; font-size:1rem; padding-top:10px;">اسم الطالب: ...........................</div>'}
                    <p style="font-size:0.9rem; color:gray; margin-top:20px;">منصة الأمين التعليمية - صالحة للاستخدام مرة واحدة</p>
                </div>
                <script>setTimeout(() => { window.print(); window.close(); }, 500);<\/script>
            `);
        }

        async function printCustomVouchers() {
            const grade = document.getElementById('print-grade-select').value;
            const count = parseInt(document.getElementById('print-count-input').value);
            if (!count || count < 1) return alert('برجاء إدخال كمية صحيحة');

            const snap = await db.collection('vouchers')
                .where('grade', '==', grade)
                .where('used', '==', false)
                .limit(count)
                .get();

            if (snap.empty) return alert('لا توجد أكواد متاحة لهذه المرحلة');

            const win = window.open('', '_blank');
            let content = `
            <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:15px; direction:rtl; font-family:sans-serif;">
            `;
            snap.forEach(doc => {
                const v = doc.data();
                content += `
                    <div style="border:2px dashed #6366f1; padding:15px; text-align:center; border-radius:15px; page-break-inside: avoid;">
                        <h3 style="margin:5px 0; color:#6366f1;">مستر أمين الغازي</h3>
                        <p style="font-size:0.8rem; margin:5px 0;">${getGradeName(v.grade)}</p>
                        <div style="font-size:1.6rem; font-weight:bold; margin:10px 0; background:#f1f5f9; padding:10px; border-radius:8px; letter-spacing:3px;">${v.code}</div>
                        ${v.studentName ? `<p style="font-weight:bold; color:#1e293b; margin:5px 0;">الطالب: ${v.studentName}</p>` : '<div style="height:25px; border-bottom:1px solid #ccc; margin-top:10px;">اسم الطالب: .................</div>'}
                        <p style="font-size:0.6rem; color:gray; margin-top:5px;">منصة الأمين التعليمية - كود لكل درس</p>
                    </div>
                `;
            });
            content += '</div>';
            win.document.write(content + '<script>setTimeout(() => { window.print(); window.close(); }, 700);<\/script>');
        }

        // --- Quiz Creation ---
        function addQuestionRaw() {
            const container = document.getElementById('questions-container');
            if (!container) return;
            const qIdx = container.children.length;
            const qDiv = document.createElement('div');
            qDiv.className = 'panel';
            qDiv.style.background = 'rgba(255,255,255,0.02)';
            qDiv.style.marginTop = '20px';
            qDiv.innerHTML = `
                <div class="form-group">
                    <label>السؤال ${qIdx + 1}</label>
                    <input type="text" class="form-control q-text" placeholder="اكتب نص السؤال هنا...">
                </div>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label>الاختيار A</label>
                        <input type="text" class="form-control opt-a" placeholder="الاختيار الأول">
                    </div>
                    <div class="form-group">
                        <label>الاختيار B</label>
                        <input type="text" class="form-control opt-b" placeholder="الاختيار الثاني">
                    </div>
                    <div class="form-group">
                        <label>الاختيار C</label>
                        <input type="text" class="form-control opt-c" placeholder="الاختيار الثالث">
                    </div>
                    <div class="form-group">
                        <label>الاختيار D</label>
                        <input type="text" class="form-control opt-d" placeholder="الاختيار الرابع">
                    </div>
                </div>
                <div class="form-group">
                    <label>الاختيار الصحيح</label>
                    <select class="form-control correct-opt">
                        <option value="0">A</option>
                        <option value="1">B</option>
                        <option value="2">C</option>
                        <option value="3">D</option>
                    </select>
                </div>
                <button class="btn btn-danger" style="padding: 10px 20px; font-size: 0.8rem;" onclick="this.parentElement.remove()">حذف السؤال</button>
            `;
            container.appendChild(qDiv);
        }

        async function saveQuiz() {
            const title = document.getElementById('quiz-title').value;
            const grade = document.getElementById('quiz-grade').value;
            const container = document.getElementById('questions-container');
            if (!title) return alert('برجاء إدخال عنوان الاختبار');
            const qElements = container.querySelectorAll('.panel');
            const quizQuestions = [];
            qElements.forEach(el => {
                const text = el.querySelector('.q-text').value;
                const options = [
                    el.querySelector('.opt-a').value, el.querySelector('.opt-b').value,
                    el.querySelector('.opt-c').value, el.querySelector('.opt-d').value
                ];
                const correct = parseInt(el.querySelector('.correct-opt').value);
                if (text && options.every(o => o)) quizQuestions.push({ text, options, correct });
            });
            if (quizQuestions.length === 0) return alert('يجب إضافة سؤال واحد على الأقل كاملاً');
            try {
                await db.collection('quizzes').add({
                    title, grade, questions: quizQuestions, createdAt: Date.now()
                });
                alert('تم حفظ الاختبار بنجاح!');
                location.reload();
            } catch (e) { console.error(e); alert('خطأ في حفظ الاختبار'); }
        }

        function loadQuizzes() {
            db.collection('quizzes').orderBy('createdAt', 'desc').onSnapshot(snap => {
                const container = document.getElementById('existing-quizzes');
                if (!container) return;
                container.innerHTML = '';
                snap.forEach(doc => {
                    const q = doc.data();
                    container.innerHTML += `
                        <tr>
                            <td style="font-weight:700;">${q.title}</td>
                            <td><span class="badge badge-warning">${getGradeName(q.grade)}</span></td>
                            <td>${q.questions ? q.questions.length : 0} سؤال</td>
                            <td>
                                <button onclick="deleteDoc('quizzes', '${doc.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer;"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>
                    `;
                });
            });
        }
        window.addEventListener('load', loadQuizzes);

    </script>
</body>

</html>